#!/usr/bin/env ruby

$:.unshift File.expand_path(File.dirname(__FILE__) + "/../lib")

require "bundler/setup"
require "core/util.rb"
require "core/log.rb"

Log::get "mud", { :default => true, :level => Logger::DEBUG }
Log::info RUBY_VERSION, "ruby version"

require "connections/base.rb"
require "accounts/base.rb"

TICK_DURATION = 5.0 # in seconds

$connections = []

def stuff
  $connections += Connections::new_connections
  $connections -= Connections::new_disconnections
  Log::info "connections (#{$connections.join ", "})"
  $connections.each do |c|
    cmd = (Connections::next_command c).to_s
    Log::info "conn #{c} next cmd (#{cmd})"
    if cmd =~ /^quit$/
      Connections::send c, "thanks! bye!"
      Connections::disconnect c
    else
      Connections::send c, cmd
    end
  end
end

while true
  tick_start = Time.now
  Connections::tick
  Accounts::tick
  #stuff
  
  tick_duration = Time.now - tick_start
  Log::info "tick done, duration #{"%4.6f" % tick_duration}s, #{"%4.6f" % (tick_duration / TICK_DURATION * 100)}% capacity", "mud"
  sleep [0,TICK_DURATION - tick_duration].max
end
